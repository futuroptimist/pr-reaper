name: Close my open PRs

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "dry_run: when true, list what would be closed (no changes)"
        type: boolean
        default: true
      author:
        description: "GitHub username for author: qualifier (blank -> uses github.actor)"
        type: string
        default: ""
      org:
        description: "Limit to an org (optional, e.g. democratizedspace)"
        type: string
        default: ""
      title_filter:
        description: "Substring to match in PR title (optional, e.g. Codex)"
        type: string
        default: ""
      delete_branch:
        description: "Delete the PR source branch after closing"
        type: boolean
        default: true
      limit:
        description: "Max PRs to process (1-1000)"
        type: string
        default: "1000"
      comment:
        description: "Closing comment"
        type: string
        default: "Closing as superseded by a newer Codex run."
      exclude_urls:
        description: "PR URLs to skip (space/comma/newline separated, optional)"
        type: string
        default: ""

permissions:
  contents: read
  pull-requests: write

jobs:
  reap:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PR_REAPER_TOKEN != '' && secrets.PR_REAPER_TOKEN || github.token }}

    steps:
      - name: Show auth identity
        run: |
          set -euo pipefail

          echo "gh version:"; gh --version | head -n1 || true
          echo "gh auth status:"; gh auth status || true
          echo "gh api user (login):"
          LOGIN="$(gh api user --jq .login 2>/dev/null || true)"
          echo "${LOGIN:-"(none)"}"

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "::error::GH_TOKEN is not set; add PR_REAPER_TOKEN with repo scope."
            exit 1
          fi

          if [ -z "${LOGIN:-}" ]; then
            echo "::error::gh is unauthenticated; check PR_REAPER_TOKEN."
            exit 1
          fi

          RAW_HEADERS="$(gh api -i user 2>/dev/null | tr -d '\r' || true)"
          SCOPES="$(awk 'BEGIN{IGNORECASE=1} /^x-oauth-scopes:/ {sub(/^x-oauth-scopes:[[:space:]]*/,""); print}' \
            <<< "$RAW_HEADERS")"

          if [ -z "${SCOPES:-}" ]; then
            SCOPES="$(gh auth status 2>/dev/null | sed -n 's/.*Token scopes: \(.*\)$/\1/p' | tr -d ,)"
          fi

          SCOPES_TRIM="$(echo "${SCOPES:-}" | xargs || true)"
          echo "token scopes (best-effort): ${SCOPES_TRIM:-"(unknown)"}"

          has_repo=0
          has_readorg=0
          if grep -Eiq '(^|[[:space:],])repo([[:space:],]|$)' <<< "${SCOPES_TRIM:-}"; then
            has_repo=1
          fi

          if grep -Eiq '(^|[[:space:],])read:org([[:space:],]|$)' <<< "${SCOPES_TRIM:-}"; then
            has_readorg=1
          fi

          ORG_INPUT="${{ inputs.org }}"

          if [ "$has_repo" -ne 1 ]; then
            echo "::error::GH_TOKEN lacks 'repo' scope; add PR_REAPER_TOKEN with repo scope."
            exit 1
          fi

          if [ -n "$ORG_INPUT" ] && [ "$has_readorg" -ne 1 ]; then
            echo "::error::GH_TOKEN lacks 'read:org' scope required for org searches."
            exit 1
          fi

          if [ "$has_readorg" -ne 1 ]; then
            echo "::warning::Could not verify 'read:org'; org PRs may be skipped."
          fi

      - name: Run pr-reaper action
        uses: ./
        with:
          dry_run: ${{ inputs.dry_run }}
          author: ${{ inputs.author }}
          org: ${{ inputs.org }}
          title_filter: ${{ inputs.title_filter }}
          delete_branch: ${{ inputs.delete_branch }}
          limit: ${{ inputs.limit }}
          comment: ${{ inputs.comment }}
          exclude_urls: ${{ inputs.exclude_urls }}
